@page "/canchas"

@using API.Clients
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@using System.Net.Http.Headers
@using CanchaDto = DTOs.Cancha
@using EstadoCancha = Domain.Model.EstadoCancha
@using Blazor.WebAssembly.Shared
@inject ICanchaClient CanchaClient
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IAuthService Auth
@inject HttpClient Http

<VolverAtras />

<h3 class="mb-3">Listado de Canchas Disponibles</h3>

@if (!string.IsNullOrEmpty(ClienteEmail))
{
    <h4 class="text-primary mb-4">👋 Bienvenido, @ClienteEmail</h4>
}
else
{
    <h4 class="text-secondary mb-4">👋 Bienvenido</h4>
}

@if (IsLoading)
{
    <p>Cargando...</p>
}
else if (!string.IsNullOrEmpty(Error))
{
    <div class="alert alert-danger">@Error</div>
}
else
{
    <!-- Filtro -->
    <div class="card mb-3 p-3">
        <div class="fw-semibold mb-2">Filtrar por Tipo de Cancha</div>
        <InputRadioGroup @bind-Value="_tipoFiltro" class="d-flex gap-4 align-items-center">
            <label class="form-check form-check-inline">
                <InputRadio class="form-check-input" Value="@("all")" />
                <span class="ms-1">Todas</span>
            </label>
            <label class="form-check form-check-inline">
                <InputRadio class="form-check-input" Value="@("5")" />
                <span class="ms-1">Fútbol 5</span>
            </label>
            <label class="form-check form-check-inline">
                <InputRadio class="form-check-input" Value="@("7")" />
                <span class="ms-1">Fútbol 7</span>
            </label>
        </InputRadioGroup>
    </div>

    <!-- Tabla -->
    @if (!Filtradas.Any())
    {
        <div class="alert alert-warning">No hay canchas para mostrar con ese filtro.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>N°</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Precio/Hora</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Filtradas)
                    {
                        var disponible = (c.Estado == EstadoCancha.Disponible);
                        <tr class="@(_canchaSeleccionada?.NroCancha == c.NroCancha ? "table-primary" : null)">
                            <td>@c.NroCancha</td>
                            <td>@(disponible ? "Disponible" : "Ocupada")</td>
                            <td>@c.TipoCancha</td>
                            <td>@c.PrecioPorHora.ToString("C", CultureInfo.CurrentCulture)</td>
                            <td>
                                <button class="btn btn-success btn-sm"
                                        disabled="@(!disponible)"
                                        @onclick="() => MostrarDetalle(c)">
                                    Reservar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <!-- Panel de disponibilidad (detalle) -->
    @if (_canchaSeleccionada is not null)
    {
        <div class="card mt-4 p-3">
            <h5>Cancha N° @_canchaSeleccionada.NroCancha - Fútbol @_canchaSeleccionada.TipoCancha</h5>
            <div class="text-muted">Precio: @_canchaSeleccionada.PrecioPorHora.ToString("C", CultureInfo.CurrentCulture)</div>

            <div class="row g-3 align-items-center mt-2">
                <div class="col-auto">
                    <label class="col-form-label">Fecha:</label>
                </div>
                <div class="col-auto">
                    <InputDate @bind-Value="_fecha" class="form-control" />
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-primary" @onclick="CargarDisponibilidad">Actualizar</button>
                </div>
            </div>

            @* MENSAJES *@
            @if (!string.IsNullOrEmpty(SuccessMsg))
            {
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    @SuccessMsg
                    <button type="button" class="btn-close" @onclick="() => SuccessMsg = null"></button>
                </div>
            }
            @if (!string.IsNullOrEmpty(ErrorReserva))
            {
                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                    @ErrorReserva
                    <button type="button" class="btn-close" @onclick="() => ErrorReserva = null"></button>
                </div>
            }

            @if (IsLoadingSlots)
            {
                <p class="mt-3">Cargando disponibilidad...</p>
            }
            else if (!string.IsNullOrEmpty(ErrorSlots))
            {
                <div class="alert alert-danger mt-3">@ErrorSlots</div>
            }
            else
            {
                <div class="table-responsive mt-3">
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Horario</th>
                                <th>Estado</th>
                                <th style="width:140px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in Slots)
                            {
                                var rango = $"{s.HoraDesde} - {s.HoraHasta}";
                                <tr class="@(s.Disponible ? null : "table-active")">
                                    <td>@rango</td>
                                    <td>@(s.Disponible ? "Disponible" : "Ocupado")</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm"
                                                disabled="@(!s.Disponible)"
                                                @onclick="() => Reservar(s)">
                                            Reservar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
}

<button class="btn btn-outline-primary mt-3" @onclick="Reload">Recargar</button>

@code {
    private string? ClienteEmail; // 👈 Mail mostrado y enviado al backend
    private bool IsLoading = true;
    private string? Error;

    // Mensajes para el panel de detalle
    private string? SuccessMsg;
    private string? ErrorReserva;

    // Datos
    private List<CanchaDto> _canchas = new();

    // Filtro: "all" | "5" | "7"
    private string _tipoFiltro = "all";
    private IEnumerable<CanchaDto> Filtradas =>
        _tipoFiltro == "all"
            ? _canchas
            : _canchas.Where(c => c.TipoCancha.ToString() == _tipoFiltro);

    // Detalle reserva
    private CanchaDto? _canchaSeleccionada;
    private DateOnly _fecha = DateOnly.FromDateTime(DateTime.Now);
    private List<DTOs.TurnoSlotDto> Slots = new();
    private bool IsLoadingSlots;
    private string? ErrorSlots;

    protected override async Task OnInitializedAsync()
    {
        // 🧠 Email del usuario (lo trae del storage/JWT según tu AuthService)
        ClienteEmail = await Auth.GetUsernameAsync();
        Console.WriteLine($"📧 Email cargado en Canchas: {ClienteEmail}");

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            IsLoading = true;
            Error = null;
            var data = await CanchaClient.GetAllAsync();
            _canchas = data.ToList();
        }
        catch (Exception ex)
        {
            Error = $"No se pudieron cargar las canchas: {ex.Message}";
        }
        finally { IsLoading = false; }
    }

    private async Task Reload() => await LoadAsync();

    private async Task CargarDisponibilidad()
    {
        if (_canchaSeleccionada is null) return;

        try
        {
            // limpiar mensajes al cambiar fecha o recargar
            SuccessMsg = null;
            ErrorReserva = null;

            IsLoadingSlots = true;
            ErrorSlots = null;
            Slots.Clear();
            var data = await CanchaClient.GetDisponibilidadAsync(_canchaSeleccionada.NroCancha, _fecha);
            Slots = data.ToList();
        }
        catch (Exception ex)
        {
            ErrorSlots = $"No se pudo obtener la disponibilidad: {ex.Message}";
        }
        finally { IsLoadingSlots = false; }
    }

    private async Task Reservar(DTOs.TurnoSlotDto slot)
    {
        if (_canchaSeleccionada is null) return;

        // limpiar mensajes previos
        SuccessMsg = null;
        ErrorReserva = null;

        try
        {
            
            

            //  Email del usuario: usa el que ya cargamos; si no, intenta del localStorage como respaldo
            var email = ClienteEmail;
            if (string.IsNullOrWhiteSpace(email))
            {
                email = await JS.InvokeAsync<string>("localStorage.getItem", "email");
            }
            if (string.IsNullOrWhiteSpace(email))
            {
                await JS.InvokeVoidAsync("alert", "No hay un email guardado. Iniciá sesión primero.");
                return;
            }

            // Armamos la request con mailUsuario (Opción A)
            var req = new
            {
                fecha = _fecha.ToString("yyyy-MM-dd"),
                horaDesde = slot.HoraDesde,
                horaHasta = slot.HoraHasta,
                mailUsuario = email   // 👈 clave para que el backend NO use 'invitado@local'
            };

            //  POST directo al endpoint de reservas de canchas
            var resp = await Http.PostAsJsonAsync($"/canchas/{_canchaSeleccionada.NroCancha}/reservas", req);

            if (resp.IsSuccessStatusCode)
            {
                await CargarDisponibilidad();

                SuccessMsg = $"✅ Reserva confirmada para el día {_fecha:dd/MM/yyyy} de {slot.HoraDesde} a {slot.HoraHasta} en la cancha N° {_canchaSeleccionada.NroCancha}.";

                // autocerrar a los 4s
                _ = Task.Run(async () =>
                {
                    await Task.Delay(4000);
                    SuccessMsg = null;
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                var msg = await resp.Content.ReadAsStringAsync();
                ErrorReserva = $"No se pudo reservar el horario. {msg}";
            }
        }
        catch (Exception ex)
        {
            ErrorReserva = $"Ocurrió un error al intentar reservar. Detalle: {ex.Message}";
        }
    }

    private async Task MostrarDetalle(CanchaDto cancha)
    {
        _canchaSeleccionada = cancha;

        // limpiar mensajes al cambiar de cancha
        SuccessMsg = null;
        ErrorReserva = null;

        await CargarDisponibilidad();
    }
}
